---
title: "Roadmap"
format: 
  html:
    page-layout: full
---

```{python}
#| label: roadmap
#| echo: false
#| output: asis

import vote
import pandas as pd
import plotly.express as px
from itables import init_notebook_mode, show

init_notebook_mode(all_interactive=False)


# Load voting results
results = vote.run_election('./roadmap/votes', 1, "./roadmap/tasks.csv")
avg_table = results["avg_table"]

# Load all tasks (preserve Effort and other columns)
tasks_df = pd.read_csv("./roadmap/tasks.csv")
if "Priority" not in tasks_df.columns:
    tasks_df["Priority"] = 0
# Merge in Priority from avg_table (by Task, left join)
priority_df = avg_table[["Task", "Priority"]]
df = tasks_df.merge(priority_df, on="Task", how="left", suffixes=("", "_voted"))
# Use voted Priority if available, else fallback to original
df["Priority"] = df["Priority_voted"].fillna(df["Priority"])
df.drop(columns=["Priority_voted"], inplace=True)
# Fill missing Effort with 0 and filter out negative Effort
df["Effort"] = df["Effort"].fillna(0)
df = df[df["Effort"] >= 0]

# Filter non-archived tasks
df = df[df['Archived_on'].isna()]
df = df.drop(columns=["Archived_on"], errors="ignore")

# Reorder columns
df = df[["Category", "Task", "Priority", "Effort", "Notes"]]

# Compute Pareto frontier: sort by priority (desc), then keep tasks with effort < min_effort_so_far
df_sorted = df.sort_values(by="Priority", ascending=False)
pareto_tasks = []
min_effort = float('inf')
for _, row in df_sorted.iterrows():
    if row["Effort"] <= min_effort:
        pareto_tasks.append(row["Task"])
        min_effort = row["Effort"]

# Highlight Pareto-optimal tasks
df["Pareto"] = df["Task"].isin(pareto_tasks)
df["Task_Display"] = df.apply(lambda r: f"{r['Task']} ðŸš¨" if r["Pareto"] else r["Task"], axis=1)

# Interactive scatter plot
fig = px.scatter(
    df,
    x="Effort",
    y="Priority",
    color="Pareto",
    hover_data=["Task_Display", "Category", "Notes"],
    title="Feature Roadmap: Priority vs Effort (Pareto Frontier)",
    labels={"Effort": "Effort (1-100 Scale)", "Priority": "Priority (Higher = More Votes)"}
)
fig.update_traces(marker=dict(size=12))

# Add step line for Pareto frontier
pareto_points = df[df["Pareto"]].sort_values(by="Effort")
if len(pareto_points) > 1:
    fig.add_scatter(
        x=pareto_points["Effort"],
        y=pareto_points["Priority"],
        mode="lines",
        line=dict(dash="dot", width=2),
        name="Pareto Frontier"
    )

fig.show()

print("""
## Archived Tasks

Archived tasks

<details>
<summary>Show archived tasks</summary>
""")

archived_tasks_df = vote.get_archived_tasks_table('./roadmap/tasks.csv')
archived_tasks_df["Notes"] = archived_tasks_df["Notes"].fillna("")
archived_tasks_df.reset_index(drop=True, inplace=True)

show(archived_tasks_df)

print("""
</details>
""")

print("""

## Raw Votes

<details>
<summary>Show raw votes table</summary>

Raw votes count

""")

votes_dict = vote.get_votes('./roadmap/votes')
votes_df = pd.DataFrame(votes_dict)
votes_df = votes_df.fillna(0)
show(votes_df, paging=False)

print("""
</details>
""")
```